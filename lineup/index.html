<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fantasy Surf League â€” Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Lora:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/fantasy.css">
</head>
<body>

  <header class="app-header" id="app-header"></header>

  <main class="app-main" id="app-main">
    <div class="loading"><div class="spinner"></div><p>Loading...</p></div>
  </main>

  <footer class="app-footer" id="app-footer"></footer>

  <script type="module">
    import { initAuth, onAuth, getCurrentUser, getUserProfile } from "./js/auth.js";
    import { getCurrentEvent, getLeaderboard, getTeam, getEvents, getResults, getTeamsForEvent, getSurfers, getUser } from "./js/db.js";
    import { scoreTeam } from "./js/scoring.js";
    import { renderHeader, renderFooter, showAuthGate, showLoading, formatSalary, formatDate, statusBadge, tradingBadge, renderTable } from "./js/ui.js";

    const SEASON = 2026;

    initAuth();
    renderHeader();
    renderFooter();

    onAuth(async (user, profile) => {
      const main = document.getElementById("app-main");
      if (!user) {
        showAuthGate(main);
        return;
      }
      showLoading(main);
      await renderDashboard(main, user, profile);
    });

    async function renderDashboard(container, user, profile) {
      let currentEvent, leaderboard, events;
      try {
        [currentEvent, leaderboard, events] = await Promise.all([
          getCurrentEvent(SEASON),
          getLeaderboard(SEASON),
          getEvents(SEASON)
        ]);
      } catch (err) {
        container.innerHTML = `
          <h1 class="page-title">Fantasy Surf League</h1>
          <div class="card">
            <p class="text-muted">Unable to load data. Make sure Firebase is configured in <code>js/firebase-config.js</code>.</p>
            <p class="text-muted text-sm mt-1">${err.message}</p>
          </div>
        `;
        return;
      }

      // Get user's team for current event
      let userTeam = null;
      let userScore = null;
      if (currentEvent) {
        userTeam = await getTeam(user.uid, currentEvent.id);
        if (userTeam && currentEvent.status === "completed") {
          const results = await getResults(currentEvent.id);
          userScore = scoreTeam(userTeam, results, currentEvent.tour || "mens");
        }
      }

      // Always load surfer data for name lookups
      let allTeamsData = [];
      const surferMap = {};
      const surfers = await getSurfers();
      surfers.forEach((s) => { surferMap[s.id] = s; });

      // Load all teams when trading is closed
      if (currentEvent && !currentEvent.tradingOpen) {
        const allTeams = await getTeamsForEvent(currentEvent.id);
        for (const team of allTeams) {
          const userDoc = await getUser(team.userId);
          allTeamsData.push({
            ...team,
            displayName: userDoc?.displayName || "Unknown",
            teamName: userDoc?.teamName || userDoc?.displayName || "â€”",
            avatarUrl: userDoc?.avatarUrl || ""
          });
        }
      }

      // Enrich leaderboard with fresh user profile data (avatar, team name)
      for (const entry of leaderboard) {
        const userDoc = await getUser(entry.userId);
        if (userDoc) {
          entry.avatarUrl = userDoc.avatarUrl || "";
          entry.teamName = userDoc.teamName || entry.teamName || userDoc.displayName || "";
          entry.displayName = userDoc.displayName || entry.displayName || "";
        }
      }

      // Sort leaderboard by bestNineTotal
      leaderboard.sort((a, b) => (b.bestNineTotal || 0) - (a.bestNineTotal || 0));

      // Profile section â€” team name + avatar
      const avatarUrl = profile?.avatarUrl || profile?.photoUrl || user.photoURL || "";
      const avatarPreview = avatarUrl
        ? `<img src="${avatarUrl}" alt="" class="avatar-preview">`
        : `<div class="avatar-preview avatar-preview--empty">${(profile?.displayName || user.displayName || "?")[0]}</div>`;

      const adsCoins = profile?.adsCoins ?? 10;
      const teamNameSection = `<div class="card mb-3">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h4 style="margin:0">Your Profile</h4>
              <span class="ads-coin-badge">ðŸª™ ${adsCoins} ADScoin</span>
            </div>
            <div class="profile-edit">
              <div class="profile-edit__avatar">
                ${avatarPreview}
              </div>
              <div class="profile-edit__fields">
                <div class="form-group mb-1">
                  <label class="form-label">Team Name</label>
                  <input type="text" class="search-input" id="team-name-input" placeholder="e.g. michael ciaramella" maxlength="30" value="${profile?.teamName || ""}">
                </div>
                <div class="form-group mb-1">
                  <label class="form-label">Avatar Image URL</label>
                  <input type="text" class="search-input" id="avatar-url-input" placeholder="https://i.imgur.com/your-image.jpg" value="${profile?.avatarUrl || ""}">
                </div>
                <p class="text-xs text-muted mb-1">Paste any image URL â€” upload to <a href="https://imgur.com" target="_blank">imgur.com</a> or use a direct link.</p>
                <button class="btn btn--primary btn--sm" id="btn-save-profile">Save Profile</button>
              </div>
            </div>
          </div>`;

      container.innerHTML = `
        <h1 class="page-title">Fantasy Surf League</h1>
        ${teamNameSection}
        <div class="grid grid--sidebar">
          <div>
            <!-- Current Event -->
            <div class="card mb-3">
              <div class="card__header">
                <span class="card__title">Current Event</span>
                ${currentEvent ? statusBadge(currentEvent.status) : ""}
              </div>
              ${currentEvent ? `
                <h3 style="margin-bottom:0.5rem">${currentEvent.name}</h3>
                <p class="text-muted text-sm">${currentEvent.location || ""}</p>
                <p class="text-sm mt-1">
                  ${formatDate(currentEvent.startDate)} â€” ${formatDate(currentEvent.endDate)}
                </p>
                <p class="mt-1">${tradingBadge(currentEvent.tradingOpen)}</p>
                <a href="event.html?id=${currentEvent.id}" class="btn btn--outline btn--sm mt-2">View Event</a>
              ` : `<p class="text-muted">No upcoming events.</p>`}
            </div>

            <!-- Your Team -->
            <div class="card mb-3">
              <div class="card__header">
                <span class="card__title">Your Team${currentEvent ? ` â€” ${currentEvent.name}` : ""}</span>
              </div>
              ${userTeam ? `
                <div class="surfer-list">
                  ${userTeam.surfers.map((s, i) => {
                    const pts = userScore?.surferScores?.[i]?.points;
                    return `<div class="surfer-row">
                      <span class="surfer-row__rank">${i + 1}</span>
                      <span class="surfer-row__name">${surferMap[s.surferId]?.name || s.surferId.replace(/-/g, " ")}</span>
                      <span class="surfer-row__value">${formatSalary(s.purchasePrice)}</span>
                      ${pts !== undefined ? `<span class="text-sm text-muted">${pts} pts</span>` : ""}
                    </div>`;
                  }).join("")}
                  ${userTeam.alternate ? `
                    <div class="surfer-row surfer-row--alternate">
                      <span class="surfer-row__rank">ALT</span>
                      <span class="surfer-row__name">${surferMap[userTeam.alternate.surferId]?.name || userTeam.alternate.surferId.replace(/-/g, " ")}</span>
                      <span class="surfer-row__value">${formatSalary(userTeam.alternate.purchasePrice)}</span>
                    </div>
                  ` : ""}
                </div>
                ${userScore ? `<p class="mt-2" style="font-weight:600">Event Total: ${userScore.totalPoints} pts</p>` : ""}
                <a href="team.html" class="btn btn--primary btn--sm mt-2">Manage Team</a>
              ` : `
                <p class="text-muted">You haven't picked a team${currentEvent ? " for this event" : ""} yet.</p>
                <a href="team.html" class="btn btn--primary btn--sm mt-2">Pick Your Team</a>
              `}
            </div>
          </div>

          <!-- Sidebar: Leaderboard + Events -->
          <div>
            <div class="card mb-3">
              <div class="card__header">
                <span class="card__title">Season Standings</span>
              </div>
              ${leaderboard.length > 0 ? `
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Team</th>
                      <th class="text-right">Best 9</th>
                      <th class="text-right">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${leaderboard.map((entry, i) => `
                      <tr class="${entry.userId === user.uid ? "highlight" : ""}">
                        <td><span class="leaderboard-rank leaderboard-rank--${i + 1}">${i + 1}</span></td>
                        <td class="flex gap-1" style="align-items:center">
                          ${entry.avatarUrl ? `<img src="${entry.avatarUrl}" class="avatar-sm">` : `<div class="avatar-sm avatar-sm--empty">${(entry.displayName || "?")[0]}</div>`}
                          ${entry.teamName || entry.displayName || "â€”"}
                        </td>
                        <td class="text-right">${entry.bestNineTotal || 0}</td>
                        <td class="text-right text-muted">${entry.allEventsTotal || 0}</td>
                      </tr>
                    `).join("")}
                  </tbody>
                </table>
              ` : `<p class="text-muted">No standings yet. Results will appear after the first event.</p>`}
            </div>

            <div class="card">
              <div class="card__header">
                <span class="card__title">${SEASON} Schedule</span>
              </div>
              ${events.length > 0 ? `
                <div class="surfer-list">
                  ${events.map((e) => `
                    <a href="event.html?id=${e.id}" class="surfer-row" style="cursor:pointer;text-decoration:none;color:inherit">
                      <span class="surfer-row__rank">${e.eventNumber}</span>
                      <span class="surfer-row__name">${e.name}</span>
                      ${statusBadge(e.status)}
                    </a>
                  `).join("")}
                </div>
              ` : `<p class="text-muted">No events scheduled yet.</p>`}
            </div>
          </div>
        </div>

        ${currentEvent && !currentEvent.tradingOpen && allTeamsData.length > 0 ? `
          <div class="mt-4">
            <h2>All Teams â€” ${currentEvent.name}</h2>
            <p class="text-muted text-sm mb-3">Trading is locked â€” all rosters are visible.</p>
            <div class="grid grid--2">
              ${allTeamsData.map((t) => `
                <div class="card">
                  <div class="card__header">
                    <span class="card__title flex gap-1" style="align-items:center">
                      ${t.avatarUrl ? `<img src="${t.avatarUrl}" class="avatar-sm">` : `<div class="avatar-sm avatar-sm--empty">${(t.displayName || "?")[0]}</div>`}
                      ${t.teamName}
                    </span>
                    <span class="text-sm text-muted">${formatSalary(t.totalSpent || 0)} spent</span>
                  </div>
                  <div class="surfer-list">
                    ${t.surfers.map((s) => {
                      const data = surferMap[s.surferId] || {};
                      return `<div class="surfer-row">
                        <span class="surfer-row__rank">${data.rank || "â€”"}</span>
                        <span class="surfer-row__name">${data.name || s.surferId.replace(/-/g, " ")}</span>
                        <span class="surfer-row__country">${data.country || ""}</span>
                        <span class="surfer-row__value">${formatSalary(s.purchasePrice)}</span>
                      </div>`;
                    }).join("")}
                    ${t.alternate ? `
                      <div class="surfer-row surfer-row--alternate">
                        <span class="surfer-row__rank">ALT</span>
                        <span class="surfer-row__name">${(surferMap[t.alternate.surferId]?.name) || t.alternate.surferId.replace(/-/g, " ")}</span>
                        <span class="surfer-row__value">${formatSalary(t.alternate.purchasePrice)}</span>
                      </div>
                    ` : ""}
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
        ` : ""}
      `;

      // Profile save handler
      document.getElementById("btn-save-profile")?.addEventListener("click", async () => {
        const name = document.getElementById("team-name-input")?.value.trim();
        const avatar = document.getElementById("avatar-url-input")?.value.trim();
        if (!name) { const { toast: t } = await import("./js/ui.js"); t("Team name is required.", "error"); return; }
        const updates = { teamName: name };
        if (avatar) updates.avatarUrl = avatar;
        else updates.avatarUrl = "";
        const { updateUser } = await import("./js/db.js");
        await updateUser(user.uid, updates);
        location.reload();
      });
    }
  </script>
</body>
</html>
