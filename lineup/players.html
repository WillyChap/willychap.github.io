<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Players — Fantasy Surf League</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Lora:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/fantasy.css">
</head>
<body>

  <header class="app-header" id="app-header"></header>

  <main class="app-main" id="app-main">
    <div class="loading"><div class="spinner"></div><p>Loading...</p></div>
  </main>

  <footer class="app-footer" id="app-footer"></footer>

  <script type="module">
    import { initAuth, onAuth } from "./js/auth.js";
    import { getAllUsers, getLeaderboard } from "./js/db.js";
    import { renderHeader, renderFooter, showAuthGate, showLoading } from "./js/ui.js";

    const SEASON = 2026;

    initAuth();
    renderHeader();
    renderFooter();

    onAuth(async (user, profile) => {
      const main = document.getElementById("app-main");
      if (!user) {
        showAuthGate(main);
        return;
      }
      showLoading(main);
      await renderPlayers(main);
    });

    async function renderPlayers(container) {
      try {
        const [users, leaderboard] = await Promise.all([
          getAllUsers(),
          getLeaderboard(SEASON)
        ]);

        // Build leaderboard lookup by userId
        const lbMap = {};
        // Sort to assign ranks
        leaderboard.sort((a, b) => (b.bestNineTotal || 0) - (a.bestNineTotal || 0));
        leaderboard.forEach((entry, i) => {
          lbMap[entry.userId] = { ...entry, rank: i + 1 };
        });

        // Merge user profiles with leaderboard stats and sort by rank (unranked last)
        const players = users.map((u) => ({
          id: u.id,
          displayName: u.displayName || "Anonymous",
          teamName: u.teamName || u.displayName || "—",
          avatarUrl: u.avatarUrl || u.photoUrl || "",
          bestNineTotal: lbMap[u.id]?.bestNineTotal || 0,
          eventsPlayed: lbMap[u.id]?.eventsPlayed || 0,
          rank: lbMap[u.id]?.rank || null
        }));

        players.sort((a, b) => {
          if (a.rank && b.rank) return a.rank - b.rank;
          if (a.rank) return -1;
          if (b.rank) return 1;
          return a.displayName.localeCompare(b.displayName);
        });

        container.innerHTML = `
          <h1 class="page-title">Players</h1>
          <p class="text-muted mb-3">${players.length} registered player${players.length !== 1 ? "s" : ""}</p>
          <div class="card">
            <table class="data-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Player</th>
                  <th class="text-right">Best 9</th>
                  <th class="text-right">Events</th>
                </tr>
              </thead>
              <tbody>
                ${players.map((p) => `
                  <tr style="cursor:pointer" onclick="window.location.href='profile.html?id=${p.id}'">
                    <td>${p.rank || "—"}</td>
                    <td class="flex gap-1" style="align-items:center">
                      ${p.avatarUrl
                        ? `<img src="${p.avatarUrl}" alt="" class="avatar-sm">`
                        : `<div class="avatar-sm avatar-sm--empty">${(p.displayName || "?")[0]}</div>`}
                      <div>
                        <strong>${p.teamName}</strong>
                        ${p.teamName !== p.displayName ? `<span class="text-xs text-muted" style="margin-left:0.5rem">${p.displayName}</span>` : ""}
                      </div>
                    </td>
                    <td class="text-right">${p.bestNineTotal}</td>
                    <td class="text-right">${p.eventsPlayed}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
          <div class="mt-3">
            <a href="index.html" class="btn btn--outline">&larr; Back to Dashboard</a>
          </div>
        `;
      } catch (err) {
        container.innerHTML = `
          <h1 class="page-title">Players</h1>
          <div class="card">
            <p class="text-muted">Unable to load players. ${err.message}</p>
          </div>
        `;
      }
    }
  </script>
</body>
</html>
